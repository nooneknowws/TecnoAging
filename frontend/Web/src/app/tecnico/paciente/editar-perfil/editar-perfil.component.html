<header class="header">
  <div class="container">
    <h1>Editar Perfil do Paciente</h1>
  </div>
</header>

<div class="my-4">
  <form [formGroup]="pacienteForm">
    <div class="row">
      <!-- Dados do Paciente -->
      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="fas fa-pencil"></i><i class="fas fa-user"></i> Editar dados do Paciente</h4>
          </div>
          <div class="card-body" formGroupName="dadosPessoais">
            <table class="table table-bordered">
              <tbody>
                <tr>
                  <th scope="row">Nome</th>
                  <td><input type="text" class="form-control form-control-sm" formControlName="nome"></td>
                </tr>
                <tr>
                  <th scope="row">Data de Nascimento</th>
                  <td><input type="date" class="form-control form-control-sm" formControlName="dataNasc"></td>
                </tr>
                <tr>
                  <th scope="row">Sexo</th>
                  <td>
                    <select class="form-select form-select-sm" formControlName="sexo">
                      <option value="">Selecione...</option>
                      <option value="Masculino">Masculino</option>
                      <option value="Feminino">Feminino</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <th scope="row">Estado Civil</th>
                  <td>
                    <select class="form-select form-select-sm" formControlName="estadoCivil">
                      <option value="">Selecione...</option>
                      <option *ngFor="let estado of getEstadoCivilOptions()" [value]="estado.value">
                        {{estado.label}}
                      </option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <th scope="row">Nacionalidade</th>
                  <td>
                    <select class="form-select form-select-sm" formControlName="nacionalidade">
                      <option value="Brasileiro">Brasileiro</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <th scope="row">Município/UF de Nascimento</th>
                  <td>
                    <div class="row">
                      <div class="col-8">
                        <input type="text" class="form-control form-control-sm" formControlName="municipioNasc">
                      </div>
                      <div class="col-4">
                        <select class="form-select form-select-sm" formControlName="ufNasc">
                          <option value="" disabled>UF</option>
                          <option *ngFor="let uf of getEstadosOptions()" [value]="uf.value">
                            {{uf.label}}
                          </option>
                        </select>
                      </div>
                    </div>
                  </td>
                </tr>
                <tr>
                  <th scope="row">Cor/Raça</th>
                  <td>
                    <select class="form-select form-select-sm" formControlName="corRaca">
                      <option value="">Selecione...</option>
                      <option *ngFor="let cor of getCorRacaOptions()" [value]="cor.value">
                        {{cor.label}}
                      </option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <th scope="row">Escolaridade</th>
                  <td>
                    <select class="form-select form-select-sm" formControlName="escolaridade">
                      <option value="">Selecione...</option>
                      <option *ngFor="let escolaridade of getEscolaridadeOptions()" [value]="escolaridade.value">
                        {{escolaridade.label}}
                      </option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <th scope="row">Peso/Altura</th>
                  <td>
                    <div class="row">
                      <div class="col-6">
                        <input type="number" step="0.01" class="form-control form-control-sm" formControlName="peso" placeholder="Peso (kg)">
                      </div>
                      <div class="col-6">
                        <input type="number" step="0.01" class="form-control form-control-sm" formControlName="altura" placeholder="Altura (m)">
                      </div>
                    </div>
                  </td>
                </tr>
                <tr>
                  <th scope="row">Situação Socioeconômica</th>
                  <td>
                    <select class="form-select form-select-sm" formControlName="socioeconomico">
                      <option value="">Selecione...</option>
                      <option *ngFor="let classe of getClasseSocioeconomicaOptions()" [value]="classe.value">
                        {{classe.label}}
                      </option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <th scope="row">Telefone</th>
                  <td><input type="tel" class="form-control form-control-sm" formControlName="telefone" mask="(00) 00000-0000" placeholder="(00) 00000-0000"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Documentação -->
      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="fas fa-id-card"></i> Documentação</h4>
          </div>
          <div class="card-body row">
            <div class="col-md-4">
              <img [src]="paciente?.fotoUrl || 'https://place-hold.it/192x256'" class="img-fluid w-100" alt="Foto do Paciente" (error)="onImageError($event)">
              <div class="mt-2">
                <input type="file" #fileInput accept="image/*" (change)="onImageSelected($event)" style="display: none;">
                <button type="button" class="btn btn-sm btn-primary w-100" (click)="fileInput.click()">
                  <i class="fas fa-camera"></i> Alterar Foto
                </button>
                <button type="button" *ngIf="paciente?.fotoUrl" class="btn btn-sm btn-danger w-100 mt-1" (click)="removerFoto()">
                  <i class="fas fa-trash"></i> Remover Foto
                </button>
              </div>
            </div>
            <div class="col-md-8" formGroupName="documentacao">
              <table class="table table-bordered">
                <tbody>
                  <tr>
                    <th scope="row">RG</th>
                    <td><input type="text" class="form-control form-control-sm" formControlName="rg" mask="00.000.000-0"></td>
                  </tr>
                  <tr>
                    <th scope="row">CPF</th>
                    <td><input type="text" class="form-control form-control-sm" formControlName="cpf" mask="000.000.000-00" placeholder="000.000.000-00"></td>
                  </tr>
                  <tr>
                    <th scope="row">Data de Expedição</th>
                    <td><input type="date" class="form-control form-control-sm" formControlName="dataExpedicao"></td>
                  </tr>
                  <tr>
                    <th scope="row">Órgão Emissor/UF</th>
                    <td>
                      <div class="row">
                        <div class="col-8">
                          <input type="text" class="form-control form-control-sm me-0" formControlName="orgaoEmissor">
                        </div>
                        <div class="col-4">
                          <select class="form-select form-select-sm ms-0" formControlName="ufEmissor">
                            <option value="" disabled>UF</option>
                            <option *ngFor="let uf of getEstadosOptions()" [value]="uf.value">
                              {{uf.label}}
                            </option>
                          </select>
                        </div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Endereço -->
      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header">
            <h4><i class="fas fa-pencil"></i> <i class="fas fa-map-marker-alt"></i> Editar endereço</h4>
          </div>
          <div class="card-body" formGroupName="endereco">
            <table class="table table-bordered">
              <tbody>
                <tr>
                  <th scope="row">CEP</th>
                  <td>
                    <div class="input-group">
                      <input class="form-control form-control-sm" type="text" formControlName="cep" #cepInput (blur)="buscarCep(cepInput.value)" mask="00000-000" placeholder="00000-000">
                      <button type="button" class="btn btn-primary btn-sm" (click)="buscarCep(cepInput.value)">
                        <i class="fas fa-search"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <th scope="row">Endereço</th>
                  <td><input type="text" class="form-control form-control-sm" formControlName="logradouro"></td>
                </tr>
                <tr>
                  <th scope="row">Número</th>
                  <td><input type="text" class="form-control form-control-sm" formControlName="numero"></td>
                </tr>
                <tr>
                  <th scope="row">Bairro</th>
                  <td><input type="text" class="form-control form-control-sm" formControlName="bairro"></td>
                </tr>
                <tr>
                  <th scope="row">Município/UF</th>
                  <td>
                    <div class="row">
                      <div class="col-8">
                        <input type="text" class="form-control form-control-sm" formControlName="municipio">
                      </div>
                      <div class="col-4">
                        <select class="form-select form-select-sm" formControlName="uf">
                          <option value="" disabled>UF</option>
                          <option *ngFor="let uf of getEstadosOptions()" [value]="uf.value">
                            {{uf.label}}
                          </option>
                        </select>
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Contatos -->
      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between">
            <h4><i class="fas fa-pencil"></i> <i class="fas fa-phone"></i> Editar contatos</h4>
            <button type="button" class="btn btn-sm btn-success" (click)="adicionarContato()">
              <i class="fas fa-plus"></i> Adicionar
            </button>
          </div>
          <div class="card-body">
            <div formArrayName="contatos">
              <ng-container *ngFor="let contato of contatosFormArray.controls; let i=index; let last=last">
                <div [formGroupName]="i">
                  <table class="table table-bordered mb-2">
                    <tbody>
                      <tr>
                        <th scope="row">Nome</th>
                        <td><input type="text" class="form-control form-control-sm" formControlName="nome"></td>
                      </tr>
                      <tr>
                        <th scope="row">Telefone</th>
                        <td>
                          <input type="tel" class="form-control form-control-sm" formControlName="telefone" mask="(00) 0000-0000||(00) 00000-0000" placeholder="(00) 00000-0000">
                          <small *ngIf="contato.get('telefone')?.invalid && contato.get('telefone')?.touched" class="text-danger">
                            Formato inválido. Use: (00) 00000-0000
                          </small>
                        </td>
                      </tr>
                      <tr>
                        <th scope="row">Parentesco</th>
                        <td>
                          <select class="form-select form-select-sm" formControlName="parentesco">
                            <option value="">Selecione...</option>
                            <option *ngFor="let parentesco of getParentescoOptions()" [value]="parentesco.value">
                              {{parentesco.label}}
                            </option>
                          </select>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                  <div class="mb-3">
                    <button type="button" class="btn btn-sm btn-danger" (click)="removerContato(i)">
                      <i class="fas fa-trash"></i> Remover
                    </button>
                  </div>
                  <hr *ngIf="!last" class="my-4" />
                </div>
              </ng-container>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="pacienteForm.invalid && pacienteForm.touched" class="alert alert-danger" role="alert">
      <i class="fas fa-exclamation-circle"></i> Formulario inválido
      <ul>
        <!-- Dados Pessoais -->
        <li *ngIf="pacienteForm.get('dadosPessoais.nome')?.invalid && pacienteForm.get('dadosPessoais.nome')?.touched">Nome é obrigatório</li>
        <li *ngIf="pacienteForm.get('dadosPessoais.dataNasc')?.invalid && pacienteForm.get('dadosPessoais.dataNasc')?.touched">Data de Nascimento é obrigatória</li>
        <li *ngIf="pacienteForm.get('dadosPessoais.sexo')?.invalid && pacienteForm.get('dadosPessoais.sexo')?.touched">Sexo é obrigatório</li>
        <li *ngIf="pacienteForm.get('dadosPessoais.estadoCivil')?.value == '' && pacienteForm.get('dadosPessoais.estadoCivil')?.touched">Estado Civil é obrigatório</li>
        <li *ngIf="pacienteForm.get('dadosPessoais.municipioNasc')?.invalid && pacienteForm.get('dadosPessoais.municipioNasc')?.touched">Município de Nascimento é obrigatório</li>
        <li *ngIf="pacienteForm.get('dadosPessoais.ufNasc')?.value == '' && pacienteForm.get('dadosPessoais.ufNasc')?.touched">UF de Nascimento é obrigatória</li>
        <li *ngIf="pacienteForm.get('dadosPessoais.corRaca')?.value == '' && pacienteForm.get('dadosPessoais.corRaca')?.touched">Cor/Raça é obrigatória</li>
        <li *ngIf="pacienteForm.get('dadosPessoais.escolaridade')?.value == '' && pacienteForm.get('dadosPessoais.escolaridade')?.touched">Escolaridade é obrigatória</li>
        <li *ngIf="pacienteForm.get('dadosPessoais.peso')?.invalid && pacienteForm.get('dadosPessoais.peso')?.touched">Peso é obrigatório</li>
        <li *ngIf="pacienteForm.get('dadosPessoais.altura')?.invalid && pacienteForm.get('dadosPessoais.altura')?.touched">Altura é obrigatória</li>
        <li *ngIf="pacienteForm.get('dadosPessoais.socioeconomico')?.value == '' && pacienteForm.get('dadosPessoais.socioeconomico')?.touched">Situação Socioeconômica é obrigatória</li>
        <li *ngIf="pacienteForm.get('dadosPessoais.telefone')?.invalid && pacienteForm.get('dadosPessoais.telefone')?.touched">Telefone é obrigatório</li>

        <!-- Documentação -->
        <li *ngIf="pacienteForm.get('documentacao.rg')?.invalid && pacienteForm.get('documentacao.rg')?.touched">RG é obrigatório</li>
        <li *ngIf="pacienteForm.get('documentacao.cpf')?.invalid && pacienteForm.get('documentacao.cpf')?.touched">CPF é obrigatório</li>
        <li *ngIf="pacienteForm.get('documentacao.dataExpedicao')?.invalid && pacienteForm.get('documentacao.dataExpedicao')?.touched">Data de Expedição é obrigatória</li>
        <li *ngIf="pacienteForm.get('documentacao.orgaoEmissor')?.invalid && pacienteForm.get('documentacao.orgaoEmissor')?.touched">Órgão Emissor é obrigatório</li>
        <li *ngIf="pacienteForm.get('documentacao.ufEmissor')?.value == '' && pacienteForm.get('documentacao.ufEmissor')?.touched">UF Emissor é obrigatória</li>

        <!-- Endereço -->
        <li *ngIf="pacienteForm.get('endereco.cep')?.invalid && pacienteForm.get('endereco.cep')?.touched">CEP é obrigatório</li>
        <li *ngIf="pacienteForm.get('endereco.logradouro')?.invalid && pacienteForm.get('endereco.logradouro')?.touched">Logradouro é obrigatório</li>
        <li *ngIf="pacienteForm.get('endereco.numero')?.invalid && pacienteForm.get('endereco.numero')?.touched">Número é obrigatório</li>
        <li *ngIf="pacienteForm.get('endereco.bairro')?.invalid && pacienteForm.get('endereco.bairro')?.touched">Bairro é obrigatório</li>
        <li *ngIf="pacienteForm.get('endereco.municipio')?.invalid && pacienteForm.get('endereco.municipio')?.touched">Município é obrigatório</li>
        <li *ngIf="pacienteForm.get('endereco.uf')?.value == '' && pacienteForm.get('endereco.uf')?.touched">UF é obrigatória</li>

        <!-- Contatos -->
        <ng-container *ngFor="let contato of contatosFormArray.controls; let i = index">
          <li *ngIf="contato.get('nome')?.invalid && contato.get('nome')?.touched">Nome do contato {{i+1}} é obrigatório</li>
          <li *ngIf="contato.get('telefone')?.invalid && contato.get('telefone')?.touched">Telefone do contato {{i+1}} é obrigatório</li>
          <li *ngIf="contato.get('parentesco')?.value == '' && contato.get('parentesco')?.touched">Parentesco do contato {{i+1}} é obrigatório</li>
        </ng-container>
      </ul>
    </div>

    <!-- Ações -->
    <div class="text-center">
      <button type="submit" class="btn btn-success me-2" (click)="salvar()" [disabled]="!pacienteForm.valid">
        <i class="fas fa-save"></i> Salvar
      </button>
      <button type="button" class="btn btn-secondary" (click)="voltar()">
        <i class="fas fa-arrow-left"></i> Voltar
      </button>
    </div>
  </form>
</div>